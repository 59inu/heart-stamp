<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Heart Stamp Admin Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      color: white;
      text-align: center;
      margin-bottom: 30px;
      font-size: 32px;
    }

    .token-section {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .token-section input {
      width: 100%;
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
    }

    .token-section button {
      margin-top: 10px;
      padding: 10px 20px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
    }

    .token-section button:hover {
      background: #5568d3;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .card h2 {
      font-size: 18px;
      margin-bottom: 15px;
      color: #333;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }

    .stat-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .stat-item:last-child {
      border-bottom: none;
    }

    .stat-label {
      color: #666;
      font-size: 14px;
    }

    .stat-value {
      color: #333;
      font-weight: bold;
      font-size: 16px;
    }

    .btn {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5568d3;
    }

    .btn-danger {
      background: #f56565;
      color: white;
    }

    .btn-danger:hover {
      background: #e53e3e;
    }

    .btn-success {
      background: #48bb78;
      color: white;
    }

    .btn-success:hover {
      background: #38a169;
    }

    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    textarea {
      width: 100%;
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      resize: vertical;
      min-height: 100px;
      font-family: inherit;
    }

    .result {
      margin-top: 15px;
      padding: 15px;
      background: #f7fafc;
      border-radius: 8px;
      border-left: 4px solid #667eea;
      display: none;
    }

    .result.show {
      display: block;
    }

    .result pre {
      white-space: pre-wrap;
      word-wrap: break-word;
      font-size: 13px;
      color: #2d3748;
    }

    .loading {
      text-align: center;
      color: #666;
      padding: 20px;
    }

    .error {
      color: #f56565;
      font-size: 13px;
      margin-top: 10px;
    }

    .progress-bar {
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
      margin: 10px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      transition: width 0.3s;
    }

    .comments-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .comment-item {
      padding: 12px;
      margin: 8px 0;
      background: #f7fafc;
      border-radius: 8px;
      font-size: 13px;
    }

    .comment-item .date {
      color: #667eea;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .comment-item .content {
      color: #666;
      margin: 5px 0;
      line-height: 1.4;
    }

    .comment-item .ai-comment {
      color: #333;
      margin-top: 5px;
      padding-top: 5px;
      border-top: 1px solid #e0e0e0;
    }

    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Heart Stamp Admin Dashboard</h1>

    <!-- Admin Token Section -->
    <div class="token-section">
      <h2>Admin Token</h2>
      <input type="password" id="adminToken" placeholder="Admin tokenì„ ì…ë ¥í•˜ì„¸ìš”">
      <button onclick="saveToken()">í† í° ì €ì¥</button>
      <div id="tokenStatus" class="error"></div>
    </div>

    <!-- Statistics Grid -->
    <div class="grid">
      <!-- Model Stats -->
      <div class="card">
        <h2>AI ëª¨ë¸ ì‚¬ìš© í†µê³„</h2>
        <div id="modelStats">
          <div class="loading">ë¡œë”© ì¤‘...</div>
        </div>
        <button class="btn btn-primary" onclick="loadModelStats()">ìƒˆë¡œê³ ì¹¨</button>
      </div>

      <!-- DB Stats -->
      <div class="card">
        <h2>ë°ì´í„°ë² ì´ìŠ¤ í†µê³„</h2>
        <div id="dbStats">
          <div class="loading">ë¡œë”© ì¤‘...</div>
        </div>
        <button class="btn btn-primary" onclick="loadDbStats()">ìƒˆë¡œê³ ì¹¨</button>
      </div>

      <!-- Admin Actions -->
      <div class="card">
        <h2>ê´€ë¦¬ ì‘ì—…</h2>
        <button class="btn btn-success" onclick="triggerAnalysis()">ë°°ì¹˜ ë¶„ì„ ì‹¤í–‰</button>
        <button class="btn btn-danger" onclick="resetYesterdayComments()">ì–´ì œ ì½”ë©˜íŠ¸ ì´ˆê¸°í™”</button>
        <div id="actionResult" class="result"></div>
      </div>
    </div>

    <!-- Recent Comments -->
    <div class="card" style="margin-bottom: 20px;">
      <h2>ìµœê·¼ AI ì½”ë©˜íŠ¸</h2>
      <button class="btn btn-primary" onclick="loadRecentComments()">ìµœê·¼ ì½”ë©˜íŠ¸ ì¡°íšŒ (10ê°œ)</button>
      <div id="recentComments"></div>
    </div>

    <!-- Importance Test -->
    <div class="card">
      <h2>ì¼ê¸° ì¤‘ìš”ë„ í…ŒìŠ¤íŠ¸</h2>
      <textarea id="testContent" placeholder="ì¼ê¸° ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
      <button class="btn btn-success" onclick="testImportance()" style="margin-top: 10px;">ì¤‘ìš”ë„ ë¶„ì„</button>
      <div id="importanceResult" class="result"></div>
    </div>
  </div>

  <script>
    const API_BASE = window.location.origin;

    // Load token from localStorage
    window.onload = () => {
      const token = localStorage.getItem('adminToken');
      if (token) {
        document.getElementById('adminToken').value = token;
        document.getElementById('tokenStatus').textContent = 'í† í°ì´ ì €ì¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤';
        document.getElementById('tokenStatus').style.color = '#48bb78';

        // Auto-load stats
        loadModelStats();
        loadDbStats();
      }
    };

    function saveToken() {
      const token = document.getElementById('adminToken').value.trim();
      if (!token) {
        document.getElementById('tokenStatus').textContent = 'í† í°ì„ ì…ë ¥í•˜ì„¸ìš”';
        document.getElementById('tokenStatus').style.color = '#f56565';
        return;
      }
      localStorage.setItem('adminToken', token);
      document.getElementById('tokenStatus').textContent = 'í† í°ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤';
      document.getElementById('tokenStatus').style.color = '#48bb78';

      // Auto-load stats
      loadModelStats();
      loadDbStats();
    }

    function getToken() {
      return localStorage.getItem('adminToken') || document.getElementById('adminToken').value.trim();
    }

    async function apiCall(endpoint, method = 'GET', body = null) {
      const token = getToken();
      if (!token) {
        alert('Admin tokenì„ ì…ë ¥í•˜ì„¸ìš”');
        return null;
      }

      const options = {
        method,
        headers: {
          'x-admin-token': token,
          'Content-Type': 'application/json',
        },
      };

      if (body) {
        options.body = JSON.stringify(body);
      }

      try {
        const response = await fetch(`${API_BASE}${endpoint}`, options);

        // Check if response is ok before parsing
        if (!response.ok) {
          let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
          try {
            const errorData = await response.json();
            errorMessage = errorData.message || errorMessage;
          } catch (e) {
            // JSON íŒŒì‹± ì‹¤íŒ¨ì‹œ ê·¸ëƒ¥ HTTP ì—ëŸ¬ ì‚¬ìš©
          }
          throw new Error(errorMessage);
        }

        const data = await response.json();
        return data;
      } catch (error) {
        // Fetch ìì²´ê°€ ì‹¤íŒ¨í•œ ê²½ìš° (ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬, CORS ë“±)
        if (error instanceof TypeError) {
          throw new Error('ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬: ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }
        throw error;
      }
    }

    async function loadModelStats() {
      const container = document.getElementById('modelStats');
      container.innerHTML = '<div class="loading">ë¡œë”© ì¤‘...</div>';

      try {
        const result = await apiCall('/api/admin/model-stats');
        const stats = result.data;

        const total = stats.sonnetCount + stats.haikuCount;
        const sonnetPercent = total > 0 ? Math.round((stats.sonnetCount / total) * 100) : 0;
        const haikuPercent = total > 0 ? Math.round((stats.haikuCount / total) * 100) : 0;

        container.innerHTML = `
          <div class="stat-item">
            <span class="stat-label">ì´ AI ì½”ë©˜íŠ¸</span>
            <span class="stat-value">${stats.totalComments}ê°œ</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Sonnet ì‚¬ìš©</span>
            <span class="stat-value">${stats.sonnetCount}ê°œ (${stats.sonnetPercentage}%)</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Haiku ì‚¬ìš©</span>
            <span class="stat-value">${stats.haikuCount}ê°œ (${stats.haikuPercentage}%)</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">ëª¨ë¸ ì •ë³´ ì—†ìŒ</span>
            <span class="stat-value">${stats.unknownCount}ê°œ</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">í‰ê·  ì¤‘ìš”ë„</span>
            <span class="stat-value">${stats.averageImportanceScore || 'N/A'}/40</span>
          </div>
          ${stats.sonnetAverageScore ? `
          <div class="stat-item">
            <span class="stat-label">Sonnet í‰ê·  ì ìˆ˜</span>
            <span class="stat-value">${stats.sonnetAverageScore}/40</span>
          </div>
          ` : ''}
        `;
      } catch (error) {
        container.innerHTML = `<div class="error">ì—ëŸ¬: ${error.message}</div>`;
      }
    }

    async function loadDbStats() {
      const container = document.getElementById('dbStats');
      container.innerHTML = '<div class="loading">ë¡œë”© ì¤‘...</div>';

      try {
        const result = await apiCall('/api/admin/db-stats');
        const stats = result.data;

        container.innerHTML = `
          <div class="stat-item">
            <span class="stat-label">ì´ ì¼ê¸°</span>
            <span class="stat-value">${stats.totalDiaries}ê°œ</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">AI ì½”ë©˜íŠ¸ ìˆìŒ</span>
            <span class="stat-value">${stats.diariesWithAIComment}ê°œ</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">AI ì½”ë©˜íŠ¸ ëŒ€ê¸°</span>
            <span class="stat-value">${stats.diariesWithoutAIComment}ê°œ</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">ì‚­ì œëœ ì¼ê¸°</span>
            <span class="stat-value">${stats.deletedDiaries}ê°œ</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">ì‚¬ìš©ì ìˆ˜</span>
            <span class="stat-value">${stats.uniqueUsers}ëª…</span>
          </div>
        `;
      } catch (error) {
        container.innerHTML = `<div class="error">ì—ëŸ¬: ${error.message}</div>`;
      }
    }

    async function triggerAnalysis() {
      const resultDiv = document.getElementById('actionResult');
      resultDiv.innerHTML = '<div class="loading">ë°°ì¹˜ ë¶„ì„ ì‹¤í–‰ ì¤‘...</div>';
      resultDiv.classList.add('show');

      try {
        const result = await apiCall('/api/jobs/trigger-analysis', 'POST');
        resultDiv.innerHTML = `<pre>âœ… ${result.message}</pre>`;

        // Reload stats after 2 seconds
        setTimeout(() => {
          loadModelStats();
          loadDbStats();
        }, 2000);
      } catch (error) {
        resultDiv.innerHTML = `<div class="error">âŒ ì—ëŸ¬: ${error.message}</div>`;
      }
    }

    async function resetYesterdayComments() {
      if (!confirm('ì •ë§ë¡œ ì–´ì œ ì¼ê¸°ì˜ AI ì½”ë©˜íŠ¸ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }

      const resultDiv = document.getElementById('actionResult');
      resultDiv.innerHTML = '<div class="loading">ì´ˆê¸°í™” ì¤‘...</div>';
      resultDiv.classList.add('show');

      try {
        const result = await apiCall('/api/admin/reset-yesterday-comments', 'POST');
        resultDiv.innerHTML = `<pre>âœ… ${result.message}\nì´ˆê¸°í™”ëœ ì¼ê¸°: ${result.count}ê°œ</pre>`;

        // Reload stats
        setTimeout(() => {
          loadModelStats();
          loadDbStats();
        }, 1000);
      } catch (error) {
        resultDiv.innerHTML = `<div class="error">âŒ ì—ëŸ¬: ${error.message}</div>`;
      }
    }

    async function loadRecentComments() {
      const container = document.getElementById('recentComments');
      container.innerHTML = '<div class="loading">ë¡œë”© ì¤‘...</div>';

      try {
        const result = await apiCall('/api/admin/recent-comments?limit=10');
        const comments = result.data;

        if (comments.length === 0) {
          container.innerHTML = '<div class="loading">ì½”ë©˜íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
          return;
        }

        container.innerHTML = '<div class="comments-list">' + comments.map(comment => {
          const date = new Date(comment.date).toLocaleString('ko-KR');
          const content = comment.content.substring(0, 100) + (comment.content.length > 100 ? '...' : '');
          const aiComment = comment.aiComment.substring(0, 150) + (comment.aiComment.length > 150 ? '...' : '');
          const model = comment.model ? ` [${comment.model.toUpperCase()}]` : '';
          const score = comment.importanceScore ? ` (${comment.importanceScore}ì )` : '';

          return `
            <div class="comment-item">
              <div class="date">${date}${model}${score}</div>
              <div class="content">${content}</div>
              <div class="ai-comment">ğŸ’¬ ${aiComment}</div>
            </div>
          `;
        }).join('') + '</div>';
      } catch (error) {
        container.innerHTML = `<div class="error">ì—ëŸ¬: ${error.message}</div>`;
      }
    }

    async function testImportance() {
      const content = document.getElementById('testContent').value.trim();
      const resultDiv = document.getElementById('importanceResult');

      if (!content) {
        alert('ì¼ê¸° ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”');
        return;
      }

      resultDiv.innerHTML = '<div class="loading">ë¶„ì„ ì¤‘...</div>';
      resultDiv.classList.add('show');

      try {
        const result = await apiCall('/api/admin/test-importance', 'POST', { content });
        const data = result.data;

        resultDiv.innerHTML = `
          <pre><strong>ì¤‘ìš”ë„ ë¶„ì„ ê²°ê³¼</strong>

ê°ì •ì  ê°•ë„: ${data.emotional_intensity}/10
ì˜ë¯¸ìˆëŠ” ì‚¬ê±´: ${data.significant_event}/10
ì„±ì°°ì˜ ê¹Šì´: ${data.depth_of_reflection}/10
ë³€í™”ì˜ ì‹ í˜¸: ${data.change_signal}/10

<strong>ì´ì : ${data.total}/40</strong>
ì„ê³„ê°’: ${data.threshold}ì 
<strong>ì„ íƒ ëª¨ë¸: ${data.selected_model.toUpperCase()}</strong>

<strong>íŒë‹¨ ì´ìœ :</strong>
${data.reason}</pre>
        `;
      } catch (error) {
        resultDiv.innerHTML = `<div class="error">âŒ ì—ëŸ¬: ${error.message}</div>`;
      }
    }
  </script>
</body>
</html>
